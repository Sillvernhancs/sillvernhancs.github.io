<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hexapod Pack Opener</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <script>
        // Image protection measures (disabled in debug mode)
        (function() {
            'use strict';
            
            const urlParams = new URLSearchParams(window.location.search);
            const debugMode = urlParams.get('debug') === 'true';
            
            if (!debugMode) {
                // Disable right-click context menu
                document.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // Disable common keyboard shortcuts for dev tools and saving
                document.addEventListener('keydown', function(e) {
                    // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S, Ctrl+A, Ctrl+P
                    if (e.keyCode === 123 || 
                        (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                        (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 65 || e.keyCode === 80))) {
                        e.preventDefault();
                        return false;
                    }
                });
            }
            
            // Disable drag and drop on all images
            document.addEventListener('dragstart', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Additional protection against image theft
            document.addEventListener('selectstart', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Override the normal image loading for card images
            window.setProtectedImage = function(imgElement, src) {
                imgElement.src = src;
                
                // Add additional layer - make images unselectable
                imgElement.style.webkitUserSelect = 'none';
                imgElement.style.mozUserSelect = 'none';
                imgElement.style.msUserSelect = 'none';
                imgElement.style.userSelect = 'none';
                imgElement.draggable = false;
            };
            
        })();

        // ===========================================
        // CONFIG - Replace with your actual values
        // ===========================================
        const CONFIG = {
            // Your Supabase project URL (found in Supabase Settings > API)
            SUPABASE_URL: 'https://ewndxtwgdmsfdfledixs.supabase.co',
            
            // Your Supabase anon key (found in Supabase Settings > API)
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3bmR4dHdnZG1zZmRmbGVkaXhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MDQwNjMsImV4cCI6MjA3MTk4MDA2M30.a2_vA5GVCB4dqddtRzdOuNNeaVan3rtJt7UE9PQl74I',
            
            // Your Discord application client ID (from Discord Developer Portal)
            DISCORD_CLIENT_ID: '1409944634045763625',
            
            // Your redirect URI (your GitHub Pages URL or localhost for testing)
            DISCORD_REDIRECT_URI: 'http://sillvernhancs.github.io',
            
            // Alternative for local testing:
            // DISCORD_REDIRECT_URI: 'http://localhost:8000/',
        };

        
        // REPLACE THESE WITH YOUR OWN ASSETS
        const PACK_IMAGE = 'HexapodTCGPack.png';
        
        // Card collection with rarity and image URLs
        const CARD_COLLECTION = {
            common: [
                { name: 'The Soldier Ant', image: 'bugs_card/ant.png' },
                { name: 'The House Spider', image: 'bugs_card/spider.png'},
                { name: 'The Bumble Bee', image: 'bugs_card/bee.png'},
                { name: 'The Pill Bug', image: 'bugs_card/pill.png'},
                { name: 'The Grass Hopper', image: 'bugs_card/cricket.png'},
            ],
            uncommon: [
                { name: 'The Tiger Beetle', image: 'bugs_card/tiger.png' },
                { name: 'The Black Beetle', image: 'bugs_card/blackbeetle.png' },
                { name: 'The Diving Bell Spider', image: 'bugs_card/divingbell.png' },
                { name: 'The Dung Beetle', image: 'bugs_card/dungbeetle.png' },
                { name: 'The Mole Cricket', image: 'bugs_card/mole.png' },
                { name: 'The Wasp', image: 'bugs_card/wasp.png' },
            ],
            legendary: [
                { name: 'The Praying Mantis', image: 'bugs_card/mantis.png' },
                { name: 'The Dragon Fly', image: 'bugs_card/dragon.png' },
                { name: 'The Rhino Beetle', image: 'bugs_card/rihno.png' },
            ]
        };

        // Audio settings
        const AUDIO_SETTINGS = {
            backgroundMusic: 'sfx/backtrack.mp3',
            packOpen: 'sfx/tcg pack open.mp3',
            cardSlam: 'sfx/Card Deal 2.wav',
            commonReveal: 'sfx/card_deal.mp3',
            uncommonReveal: 'sfx/card_deal.mp3',
            legendaryReveal: 'sfx/card_deal.mp3',
            legendaryAnoucement: 'sfx/legendary annoucement.mp3',
            uncommonAnoucement: 'sfx/uncommon.mp3',
            allCardsReveal: 'sfx/cardflips.mp3',
            allCardsReveal_withLegendary: ''
        };
    </script>

    <div class="particles" id="particles"></div>
    <div class="flash-overlay" id="flashOverlay"></div>
    <div class="lightning" id="lightning"></div>
    <div class="legendary-announcement" id="legendaryAnnouncement">LEGENDARY!</div>
    
    <!-- Discord Login Screen -->
    <div class="discord-login" id="discordLogin">
        <div class="login-container">
            <h1 class="title">Hexapod TCG</h1>
            <div class="login-card">
                <h2>Daily Pack Opener</h2>
                <p>Login with Discord to open your daily pack!</p>
                <button class="discord-btn" id="discordLoginBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419-.0190 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1568 2.4189Z"/>
                    </svg>
                    Login with Discord
                </button>
                <div class="user-info" id="userInfo" style="display: none;">
                    <img id="userAvatar" src="" alt="Avatar" class="user-avatar">
                    <span id="userName">Loading...</span>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
                <div class="loading-message" id="loadingMessage" style="display: none;">
                    <p>Authenticating...</p>
                </div>
                <div class="error-message" id="errorMessage" style="display: none;">
                    <p id="errorText">An error occurred. Please try again.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Game -->
    <div class="container" id="mainContainer" style="display: none;">
        <div class="user-bar" id="userBar">
            <div class="user-display">
                <img id="gameUserAvatar" src="" alt="Avatar" class="small-avatar">
                <span id="gameUserName">Player</span>
            </div>
            <button class="logout-btn small" id="gameLogoutBtn">Logout</button>
        </div>
        
        <h1 class="title" id="title">Open Your Daily Pack!</h1>
        
        <div class="pack-container" id="packContainer">
            <div class="pack" id="pack">
                <img src="" id="packImage" class="pack-image" alt="Card Pack">
            </div>
            <div class="energy-ring" id="energyRing1"></div>
            <div class="energy-ring" id="energyRing2"></div>
            <div class="energy-ring" id="energyRing3"></div>
        </div>
        
        <div class="card-display" id="cardDisplay">
            <div class="card" id="currentCard">
                <div class="rarity-glow"></div>
                <img src="" id="cardImage" class="card-image" alt="Card">
            </div>
            <div class="click-hint">Click card to continue</div>
        </div>
        
        <div class="all-cards-display" id="allCardsDisplay"></div>
        
        <div class="locked-message" id="lockedMessage" style="display: none;">
            You've already opened your daily pack! Come back tomorrow for more cards.
        </div>
    </div>

    <script>
        // ===========================================
        // AUDIO MANAGER
        // ===========================================
        class AudioManager {
            constructor() {
                this.musicEnabled = true;
                this.sfxEnabled = true;
                this.volume = 0.5;
                this.backgroundMusic = null;
                this.musicWasPlaying = false;
                this.initAudio();
                this.setupVisibilityHandling();
            }

            initAudio() {
                if (AUDIO_SETTINGS.backgroundMusic) {
                    this.backgroundMusic = new Audio(AUDIO_SETTINGS.backgroundMusic);
                    this.backgroundMusic.loop = true;
                    this.backgroundMusic.volume = this.volume * 0.3;
                }
                
                document.addEventListener('click', () => {
                    if (this.musicEnabled) {
                        this.playBackgroundMusic();
                    }
                }, { once: true });
            }

            setupVisibilityHandling() {
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        if (this.backgroundMusic && !this.backgroundMusic.paused) {
                            this.musicWasPlaying = true;
                            this.backgroundMusic.pause();
                        }
                    } else {
                        if (this.musicWasPlaying && this.musicEnabled && this.backgroundMusic) {
                            this.backgroundMusic.play().catch(e => console.log('Could not resume background music'));
                        }
                    }
                });

                window.addEventListener('blur', () => {
                    if (this.backgroundMusic && !this.backgroundMusic.paused) {
                        this.musicWasPlaying = true;
                        this.backgroundMusic.pause();
                    }
                });

                window.addEventListener('focus', () => {
                    if (this.musicWasPlaying && this.musicEnabled && this.backgroundMusic) {
                        this.backgroundMusic.play().catch(e => console.log('Could not resume background music'));
                    }
                });
            }

            playAudio(filename, volume = 1.0) {
                if (!this.sfxEnabled || !filename) return;
                
                const audio = new Audio(filename);
                audio.volume = this.volume * volume;
                audio.play().catch(e => console.log('Could not play audio:', filename));
                
                return audio;
            }

            playBackgroundMusic() {
                if (!this.musicEnabled || !this.backgroundMusic) return;
                
                this.musicWasPlaying = true;
                this.backgroundMusic.currentTime = 0;
                this.backgroundMusic.play().catch(e => console.log('Could not play background music'));
            }

            stopBackgroundMusic() {
                if (this.backgroundMusic) {
                    this.musicWasPlaying = false;
                    this.backgroundMusic.pause();
                    this.backgroundMusic.currentTime = 0;
                }
            }

            play(soundName) {
                const filename = AUDIO_SETTINGS[soundName];
                if (filename) {
                    this.playAudio(filename);
                }
            }
        }

        // ===========================================
        // DISCORD AUTH CLASS
        // ===========================================
        class DiscordAuth {
            constructor() {
                this.supabaseUrl = CONFIG.SUPABASE_URL;
                this.currentUser = null;
                this.init();
            }

            init() {
                // Check for existing session
                const savedUser = localStorage.getItem('discord_user');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.showMainGame();
                } else {
                    // Check if we're returning from Discord OAuth
                    const urlParams = new URLSearchParams(window.location.search);
                    const code = urlParams.get('code');
                    
                    if (code) {
                        this.handleOAuthCallback(code);
                    } else {
                        this.showLoginScreen();
                    }
                }

                this.setupEventListeners();
            }

            setupEventListeners() {
                const discordLoginBtn = document.getElementById('discordLoginBtn');
                if (discordLoginBtn) {
                    discordLoginBtn.addEventListener('click', () => this.initiateLogin());
                }

                const logoutBtn = document.getElementById('logoutBtn');
                const gameLogoutBtn = document.getElementById('gameLogoutBtn');
                
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.logout());
                }
                
                if (gameLogoutBtn) {
                    gameLogoutBtn.addEventListener('click', () => this.logout());
                }
            }

            initiateLogin() {
                const params = new URLSearchParams({
                    client_id: CONFIG.DISCORD_CLIENT_ID,
                    redirect_uri: CONFIG.DISCORD_REDIRECT_URI,
                    response_type: 'code',
                    scope: 'identify email',
                });

                window.location.href = `https://discord.com/oauth2/authorize?${params.toString()}`;
            }

            async handleOAuthCallback(code) {
                try {
                    this.showLoading('Authenticating with Discord...');

                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);

                    // Send code to Supabase Edge Function
                    const response = await fetch(`${this.supabaseUrl}/functions/v1/discord-oauth`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                        },
                        body: JSON.stringify({ code }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Authentication failed');
                    }

                    const data = await response.json();
                    this.currentUser = data.user;

                    // Save user data to localStorage
                    localStorage.setItem('discord_user', JSON.stringify(this.currentUser));

                    this.showMainGame();
                } catch (error) {
                    console.error('OAuth callback error:', error);
                    this.showError('Authentication failed. Please try again.');
                    this.showLoginScreen();
                }
            }

            async refreshUserData() {
                if (!this.currentUser) return;

                try {
                    const response = await fetch(
                        `${this.supabaseUrl}/functions/v1/discord-oauth?user_id=${this.currentUser.id}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                            },
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        this.currentUser = data.user;
                        localStorage.setItem('discord_user', JSON.stringify(this.currentUser));
                    }
                } catch (error) {
                    console.error('Failed to refresh user data:', error);
                }
            }

            showLoginScreen() {
                document.getElementById('discordLogin').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
                this.hideLoading();
                this.hideError();
            }

            showMainGame() {
                document.getElementById('discordLogin').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';

                if (this.currentUser) {
                    // Update user display elements
                    const gameUserAvatar = document.getElementById('gameUserAvatar');
                    const gameUserName = document.getElementById('gameUserName');

                    if (gameUserAvatar && this.currentUser.avatar_url) {
                        gameUserAvatar.src = this.currentUser.avatar_url;
                        gameUserAvatar.onerror = () => {
                            gameUserAvatar.src = `https://cdn.discordapp.com/embed/avatars/0.png`;
                        };
                    }

                    if (gameUserName) {
                        gameUserName.textContent = this.currentUser.username;
                    }

                    // Check if user has already opened today's pack
                    this.updatePackStatus();
                }
            }

            updatePackStatus() {
                const titleElement = document.getElementById('title');
                const packContainer = document.getElementById('packContainer');
                const lockedMessage = document.getElementById('lockedMessage');

                if (this.currentUser && this.currentUser.has_opened_today) {
                    if (titleElement) titleElement.textContent = 'Pack Already Opened!';
                    if (packContainer) {
                        packContainer.style.opacity = '0.5';
                        packContainer.style.pointerEvents = 'none';
                    }
                    if (lockedMessage) lockedMessage.style.display = 'block';
                } else {
                    if (titleElement) titleElement.textContent = 'Open Your Daily Pack!';
                    if (packContainer) {
                        packContainer.style.opacity = '1';
                        packContainer.style.pointerEvents = 'auto';
                    }
                    if (lockedMessage) lockedMessage.style.display = 'none';
                }
            }

            showLoading(message) {
                const loadingDiv = document.getElementById('loadingMessage');
                if (loadingDiv) {
                    loadingDiv.style.display = 'block';
                    loadingDiv.querySelector('p').textContent = message;
                }
            }

            hideLoading() {
                const loadingDiv = document.getElementById('loadingMessage');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    errorDiv.querySelector('#errorText').textContent = message;
                }
            }

            hideError() {
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('discord_user');
                this.showLoginScreen();
                
                // Reset the game state
                if (window.game) {
                    window.game.reset();
                }
            }

            getCurrentUser() {
                return this.currentUser;
            }

            isLoggedIn() {
                return !!this.currentUser;
            }
        }

        // ===========================================
        // GAME CLASS
        // ===========================================
        class HexapodGame {
            constructor() {
                this.cards = [];
                this.currentCardIndex = 0;
                this.isPackOpened = false;
                this.canClickCard = false;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.createParticles();
                
                // Initialize pack image
                const packImg = document.getElementById('packImage');
                window.setProtectedImage(packImg, PACK_IMAGE);
            }

            setupEventListeners() {
                const packContainer = document.getElementById('packContainer');
                const currentCard = document.getElementById('currentCard');
                
                if (packContainer) {
                    packContainer.addEventListener('click', () => this.openPack());
                }
                
                if (currentCard) {
                    currentCard.addEventListener('click', () => this.nextCard());
                }
            }

            async openPack() {
                if (this.isPackOpened) return;
                if (!window.discordAuth || !window.discordAuth.isLoggedIn()) {
                    alert('Please log in first!');
                    return;
                }

                const user = window.discordAuth.getCurrentUser();
                if (user.has_opened_today) {
                    alert('You have already opened your daily pack! Come back tomorrow.');
                    return;
                }

                try {
                    this.showLoading(true);
                    
                    // Call the open-pack Edge Function
                    const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/open-pack`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                        },
                        body: JSON.stringify({ user_id: user.id }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to open pack');
                    }

                    const data = await response.json();
                    
                    // Convert backend cards to frontend format
                    this.cards = data.cards.map(backendCard => {
                        // Find matching card from CARD_COLLECTION
                        const rarityCards = CARD_COLLECTION[backendCard.rarity] || CARD_COLLECTION.common;
                        const matchingCard = rarityCards[Math.floor(Math.random() * rarityCards.length)];
                        
                        return {
                            ...matchingCard,
                            rarity: backendCard.rarity
                        };
                    });
                    
                    // Update user status
                    user.has_opened_today = true;
                    localStorage.setItem('discord_user', JSON.stringify(user));
                    
                    // Start pack opening animation
                    this.animatePackOpening();
                    
                } catch (error) {
                    console.error('Failed to open pack:', error);
                    alert('Failed to open pack: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            showLoading(show) {
                const pack = document.getElementById('pack');
                if (pack) {
                    pack.style.pointerEvents = show ? 'none' : 'auto';
                    pack.style.opacity = show ? '0.7' : '1';
                }
            }

            animatePackOpening() {
                this.isPackOpened = true;
                
                const packContainer = document.getElementById('packContainer');
                const pack = document.getElementById('pack');
                const cardDisplay = document.getElementById('cardDisplay');
                
                if (!pack || !cardDisplay) return;

                // Play pack opening sound
                audioManager.play('packOpen');

                // Reset title
                const title = document.getElementById('title');
                title.textContent = "";

                // Add pack opening animation
                pack.classList.add('opening');
                
                // Start energy rings animation
                this.animateEnergyRings();
                
                // Show first card after animation
                setTimeout(() => {
                    if (packContainer) packContainer.style.display = 'none';
                    cardDisplay.style.display = 'block';
                    this.showCard(0);
                }, 1300);
            }

            showCard(index) {
                if (index >= this.cards.length) {
                    this.showAllCards();
                    return;
                }

                const card = this.cards[index];
                const cardImage = document.getElementById('cardImage');
                const currentCard = document.getElementById('currentCard');
                
                if (!cardImage || !currentCard) return;

                // Force animation reset by removing and re-adding the element
                const newCard = currentCard.cloneNode(true);
                currentCard.parentNode.replaceChild(newCard, currentCard);
                
                // Get the new reference
                const updatedCard = document.getElementById('currentCard');
                const updatedImage = document.getElementById('cardImage');
                
                // Reset card with proper animation
                updatedCard.className = 'card ' + card.rarity;
                updatedCard.classList.add('card-slam');
                updatedCard.classList.remove('flipped');
                this.canClickCard = false;
                
                // Play card slam sound
                audioManager.play('cardSlam');
                
                // Update title
                this.updateTitle(card);
                
                // Set card image with protection
                window.setProtectedImage(updatedImage, card.image);

                // Special effects for rarity
                if (card.rarity === 'uncommon') {
                    audioManager.play('uncommonAnoucement');
                }
                
                if (card.rarity === 'legendary') {
                    audioManager.play('legendaryAnoucement');
                    
                    // Show legendary announcement
                    const announcement = document.getElementById('legendaryAnnouncement');
                    announcement.classList.add('show');
                    setTimeout(() => announcement.classList.remove('show'), 2000);
                    
                    // Screen shake
                    document.getElementById('mainContainer').classList.add('screen-shake');
                    setTimeout(() => {
                        document.getElementById('mainContainer').classList.remove('screen-shake');
                    }, 500);
                    
                    // Lightning effect
                    this.createLightning();
                }
                
                // Auto flip after animation
                setTimeout(() => {
                    updatedCard.classList.add('flipped');
                    this.canClickCard = true;
                    
                    // Play rarity-specific reveal sound
                    audioManager.play(card.rarity + 'Reveal');
                    
                }, card.rarity === 'legendary' ? 1200 : 600);
                
                // Re-attach click handler to the new element
                updatedCard.addEventListener('click', () => {
                    if (!this.canClickCard) return;
                    this.nextCard();
                });
                
                this.currentCardIndex = index;
            }

            nextCard() {
                if (this.currentCardIndex < this.cards.length - 1) {
                    this.showCard(this.currentCardIndex + 1);
                } else {
                    this.showAllCards();
                }
            }

            showAllCards() {
                const cardDisplay = document.getElementById('cardDisplay');
                const allCardsDisplay = document.getElementById('allCardsDisplay');
                const title = document.getElementById('title');
                
                if (cardDisplay) cardDisplay.style.display = 'none';
                if (allCardsDisplay) {
                    allCardsDisplay.style.display = 'flex';
                    allCardsDisplay.innerHTML = '';
                    
                    // Play all cards reveal sound
                    const legendaryPulled = this.cards.some(card => card.rarity === 'legendary');
                    if (legendaryPulled) {
                        audioManager.play('allCardsReveal_withLegendary');
                    } else {
                        audioManager.play('allCardsReveal');
                    }
                    
                    // Show all cards
                    this.cards.forEach((card, i) => {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'small-card ' + card.rarity;
                        cardDiv.style.animationDelay = i * 0.1 + 's';
                        
                        const img = document.createElement('img');
                        window.setProtectedImage(img, card.image);
                        img.alt = card.name;
                        
                        const glow = document.createElement('div');
                        glow.className = 'rarity-glow';
                        glow.style.opacity = '1';
                        
                        cardDiv.appendChild(glow);
                        cardDiv.appendChild(img);
                        allCardsDisplay.appendChild(cardDiv);

                        // Hover effect with burst
                        cardDiv.addEventListener('mouseenter', function(e) {
                            if (card.rarity === 'legendary') {
                                const rect = e.target.getBoundingClientRect();
                                // createBurst(rect.left + rect.width / 2, rect.top + rect.height / 2, '#ffd700', 10);
                            }
                        });
                    });
                }
                
                if (title) {
                    title.textContent = 'Your Collection!';
                    title.className = 'title';
                }
                
                // Update the auth status
                if (window.discordAuth) {
                    window.discordAuth.updatePackStatus();
                }
            }

            updateTitle(card) {
                const title = document.getElementById('title');
                if (title) {
                    title.textContent = card.name;
                    title.className = 'title card-name ' + card.rarity;
                }
            }

            animateEnergyRings() {
                const rings = ['energyRing1', 'energyRing2', 'energyRing3'];
                rings.forEach((ringId, index) => {
                    const ring = document.getElementById(ringId);
                    if (ring) {
                        setTimeout(() => {
                            ring.classList.add('active');
                        }, index * 100 + 100);
                    }
                });
            }

            createLightning() {
                const lightning = document.getElementById('lightning');
                if (lightning) {
                    lightning.innerHTML = '';
                    lightning.classList.add('active');
                    
                    for (let i = 0; i < 5; i++) {
                        const bolt = document.createElement('div');
                        bolt.className = 'lightning-bolt';
                        bolt.style.left = Math.random() * 100 + '%';
                        bolt.style.animationDelay = i * 0.1 + 's';
                        lightning.appendChild(bolt);
                    }
                    
                    setTimeout(() => {
                        lightning.classList.remove('active');
                    }, 1000);
                }
            }

            createParticles() {
                const particlesContainer = document.getElementById('particles');
                if (!particlesContainer) return;
                
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 15 + 's';
                    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                    particlesContainer.appendChild(particle);
                }
            }

            reset() {
                this.cards = [];
                this.currentCardIndex = 0;
                this.isPackOpened = false;
                this.canClickCard = false;
                
                // Reset UI
                const packContainer = document.getElementById('packContainer');
                const cardDisplay = document.getElementById('cardDisplay');
                const allCardsDisplay = document.getElementById('allCardsDisplay');
                const pack = document.getElementById('pack');
                const title = document.getElementById('title');
                
                if (packContainer) packContainer.style.display = 'flex';
                if (cardDisplay) cardDisplay.style.display = 'none';
                if (allCardsDisplay) allCardsDisplay.style.display = 'none';
                if (pack) pack.classList.remove('opening');
                if (title) {
                    title.textContent = 'Open Your Daily Pack!';
                    title.className = 'title';
                }
                
                // Clear energy rings
                const rings = ['energyRing1', 'energyRing2', 'energyRing3'];
                rings.forEach(ringId => {
                    const ring = document.getElementById(ringId);
                    if (ring) ring.classList.remove('active');
                });
            }
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        
        // Initialize audio manager
        const audioManager = new AudioManager();
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Discord Auth
            window.discordAuth = new DiscordAuth();
            
            // Initialize Game
            window.game = new HexapodGame();
        });

        // ===========================================
        // DEBUG MODE
        // ===========================================
        const urlParams = new URLSearchParams(window.location.search);
        const debugMode = urlParams.get('debug') === 'true';
        
        if (debugMode) {
            console.log('🐛 DEBUG MODE ENABLED');
            
            // Add debug panel
            const debugPanel = document.createElement('div');
            debugPanel.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: #7cfc00;
                padding: 10px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 10000;
                border: 1px solid #7cfc00;
            `;
            debugPanel.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold;">🐛 DEBUG MODE</div>
                <div style="margin-bottom: 5px; font-size: 10px; color: #999;">Right-click & F12 enabled</div>
                <button id="debugLogin" style="
                    background: #7cfc00;
                    color: #000;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 3px;
                    cursor: pointer;
                    margin: 2px;
                    font-size: 11px;
                ">Fake Login</button>
                <button id="debugReset" style="
                    background: #ff6b6b;
                    color: #fff;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 3px;
                    cursor: pointer;
                    margin: 2px;
                    font-size: 11px;
                ">Reset State</button>
                <button id="debugPack" style="
                    background: #ffd700;
                    color: #000;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 3px;
                    cursor: pointer;
                    margin: 2px;
                    font-size: 11px;
                ">Force Open Pack</button>
                <div style="margin-top: 10px; font-size: 10px;">
                    Press 'L' for fake login<br>
                    Press 'R' to reset<br>
                    Press 'P' to force pack
                </div>
            `;
            document.body.appendChild(debugPanel);
            
            // Debug login button
            document.getElementById('debugLogin').addEventListener('click', function() {
                const fakeUser = {
                    id: 'debug-user-123',
                    discord_id: '123456789',
                    username: 'Debug User',
                    avatar_url: 'https://cdn.discordapp.com/embed/avatars/0.png',
                    has_opened_today: false,
                };
                
                localStorage.setItem('discord_user', JSON.stringify(fakeUser));
                window.discordAuth.currentUser = fakeUser;
                window.discordAuth.showMainGame();
            });
            
            // Reset button
            document.getElementById('debugReset').addEventListener('click', function() {
                localStorage.clear();
                location.reload();
            });
            
            // Force pack button
            document.getElementById('debugPack').addEventListener('click', function() {
                // Generate fake pack data
                const fakeCards = [];
                for (let i = 0; i < 5; i++) {
                    const rarities = ['common', 'uncommon', 'legendary'];
                    const rarity = rarities[Math.floor(Math.random() * rarities.length)];
                    const cards = CARD_COLLECTION[rarity];
                    const card = cards[Math.floor(Math.random() * cards.length)];
                    fakeCards.push({ ...card, rarity });
                }
                
                window.game.cards = fakeCards;
                window.game.animatePackOpening();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'l' || e.key === 'L') {
                    document.getElementById('debugLogin').click();
                }
                if (e.key === 'r' || e.key === 'R') {
                    document.getElementById('debugReset').click();
                }
                if (e.key === 'p' || e.key === 'P') {
                    document.getElementById('debugPack').click();
                }
            });
        }
    </script>
</body>
</html>