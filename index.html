<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hexapod Pack Opener</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Discord Embedded App SDK -->
    <script src="https://discord.com/api/guilds/embed.js"></script>

    <div class="particles" id="particles"></div>
    <div class="flash-overlay" id="flashOverlay"></div>
    <div class="lightning" id="lightning"></div>
    <div class="legendary-announcement" id="legendaryAnnouncement">LEGENDARY!</div>
    
    <!-- Discord Only Message -->
    <div class="discord-only" id="discordOnly" style="display: none;">
        <h1>Discord Only</h1>
        <p>This pack opener only works when launched as a Discord Activity from the Hexapod Discord server.</p>
        <a href="https://discord.gg/Z3fCuYamcz" class="discord-button" target="_blank">
            Join Discord Server
        </a>
    </div>

    <!-- Authentication Loading -->
    <div class="auth-loading" id="authLoading" style="display: none;">
        <h2>Connecting to Discord...</h2>
        <div class="spinner"></div>
        <p>Please authorize this app to continue</p>
    </div>

    <!-- User Info Display -->
    <div class="user-info" id="userInfo" style="display: none;">
        <img src="" alt="User Avatar" class="user-avatar" id="userAvatar">
        <span id="username">Loading...</span>
    </div>
    
    <div class="container" id="mainContainer">
        <h1 class="title" id="title">Open Your Daily Pack!</h1>
        
        <div class="pack-container" id="packContainer">
            <div class="pack" id="pack">
                <img src="" id="packImage" class="pack-image" alt="Card Pack">
            </div>
            <div class="energy-ring" id="energyRing1"></div>
            <div class="energy-ring" id="energyRing2"></div>
            <div class="energy-ring" id="energyRing3"></div>
        </div>
        
        <div class="card-display" id="cardDisplay">
            <div class="card" id="currentCard">
                <div class="rarity-glow"></div>
                <img src="" id="cardImage" class="card-image" alt="Card">
            </div>
            <div class="click-hint">Click card to continue</div>
        </div>
        
        <div class="all-cards-display" id="allCardsDisplay"></div>
        
        <div class="locked-message" id="lockedMessage" style="display: none;">
            You've already opened your daily pack! Come back tomorrow for more cards.
        </div>
    </div>

    <script>
        // REPLACE THESE WITH YOUR ACTUAL VALUES
        const DISCORD_CLIENT_ID = 'YOUR_DISCORD_CLIENT_ID'; // Replace with your Discord App Client ID
        const YOUR_SERVER_INVITE = 'https://discord.gg/your-server-invite'; // Replace with your server invite
        
        // Discord Integration
        let discordUser = null;
        let discordSdk = null;
        let isDiscordActivity = false;

        // Check if running in Discord Activity context
        function isRunningInDiscord() {
            // Check multiple indicators that we're in Discord
            return window.parent !== window.self || 
                   window.location.hostname.includes('discordsays.com') ||
                   window.location.hostname.includes('discord.com') ||
                   window.DiscordSDK !== undefined;
        }

        // Initialize Discord SDK
        async function initializeDiscord() {
            try {
                // Try to load Discord SDK dynamically
                if (!window.DiscordSDK) {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/@discord/embedded-app-sdk@1.0.0/output/discord.js';
                    document.head.appendChild(script);
                    
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = reject;
                        setTimeout(reject, 5000); // 5 second timeout
                    });
                }

                discordSdk = new DiscordSDK(DISCORD_CLIENT_ID);
                await discordSdk.ready();
                
                // Request authorization
                const { code } = await discordSdk.commands.authorize({
                    client_id: DISCORD_CLIENT_ID,
                    response_type: 'code',
                    state: '',
                    prompt: 'none',
                    scope: ['identify'],
                });

                // In a real implementation, you'd exchange this code for an access token on your backend
                // For this demo, we'll simulate getting user info
                const mockUserData = await simulateTokenExchange(code);
                
                // Authenticate with Discord
                const auth = await discordSdk.commands.authenticate({
                    access_token: mockUserData.access_token,
                });

                discordUser = auth.user;
                isDiscordActivity = true;
                
                // Show user info
                displayUserInfo(discordUser);
                
                return true;
            } catch (error) {
                console.error('Discord authentication failed:', error);
                return false;
            }
        }

        // Simulate token exchange (replace with real backend call)
        async function simulateTokenExchange(code) {
            // In production, send the code to your backend to exchange for access token
            // For now, we'll simulate this process
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        access_token: 'simulated_token_' + code.slice(-10),
                        user: {
                            id: 'user_' + Math.random().toString(36).substr(2, 9),
                            username: 'DiscordUser' + Math.floor(Math.random() * 1000),
                            avatar: null
                        }
                    });
                }, 1000);
            });
        }

        // Display user info in the top right
        function displayUserInfo(user) {
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            const username = document.getElementById('username');
            
            username.textContent = user.username;
            
            if (user.avatar) {
                userAvatar.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
            } else {
                userAvatar.src = `https://cdn.discordapp.com/embed/avatars/${parseInt(user.id) % 5}.png`;
            }
            
            userInfo.style.display = 'block';
        }

        // Modified storage key to include Discord user ID
        function getStorageKey() {
            if (discordUser) {
                return `hexapod_last_opened_${discordUser.id}`;
            }
            return 'hexapod_last_opened'; // Fallback for non-Discord use
        }

        // Check if pack can be opened today (now user-specific)
        function canOpenPack() {
            const storageKey = getStorageKey();
            const lastOpened = localStorage.getItem(storageKey);
            if (!lastOpened) return true;
            
            const lastDate = new Date(lastOpened);
            const today = new Date();
            
            const lastMidnight = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
            const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            return todayMidnight > lastMidnight;
        }

        // Save pack opening (now user-specific)
        function savePackOpening() {
            const storageKey = getStorageKey();
            localStorage.setItem(storageKey, new Date().toISOString());
        }

        // Main initialization
        async function initialize() {
            // Check if running in Discord
            if (isRunningInDiscord()) {
                console.log('Running in Discord context');
                document.getElementById('authLoading').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
                
                const success = await initializeDiscord();
                
                if (success) {
                    document.getElementById('authLoading').style.display = 'none';
                    document.getElementById('mainContainer').style.display = 'block';
                    initializeGame();
                } else {
                    document.getElementById('authLoading').style.display = 'none';
                    document.getElementById('discordOnly').style.display = 'block';
                }
            } else {
                console.log('Not running in Discord context');
                document.getElementById('discordOnly').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
                
                // Update the Discord button with your actual invite link
                const discordButton = document.querySelector('.discord-button');
                discordButton.href = YOUR_SERVER_INVITE;
            }
        }

        // Initialize the game (existing functionality)
        function initializeGame() {
            // Image protection measures (disabled in debug mode)
            (function() {
                'use strict';
                
                const urlParams = new URLSearchParams(window.location.search);
                const debugMode = urlParams.get('debug') === 'true';
                
                if (!debugMode) {
                    document.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        return false;
                    });
                    
                    document.addEventListener('keydown', function(e) {
                        if (e.keyCode === 123 || 
                            (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                            (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 65 || e.keyCode === 80))) {
                            e.preventDefault();
                            return false;
                        }
                    });
                }
                
                document.addEventListener('dragstart', function(e) {
                    if (e.target.tagName === 'IMG') {
                        e.preventDefault();
                        return false;
                    }
                });
                
                document.addEventListener('selectstart', function(e) {
                    if (e.target.tagName === 'IMG') {
                        e.preventDefault();
                        return false;
                    }
                });
                
                window.setProtectedImage = function(imgElement, src) {
                    imgElement.src = src;
                    imgElement.style.webkitUserSelect = 'none';
                    imgElement.style.mozUserSelect = 'none';
                    imgElement.style.msUserSelect = 'none';
                    imgElement.style.userSelect = 'none';
                    imgElement.draggable = false;
                };
                
            })();
            
            // REPLACE THESE WITH YOUR OWN ASSETS
            const PACK_IMAGE = 'HexapodTCGPack.png';
            
            // Card collection with rarity and image URLs
            const CARD_COLLECTION = {
                common: [
                    { name: 'The Soldier Ant', image: 'bugs_card/ant.png' },
                    { name: 'The House Spider', image: 'bugs_card/spider.png'},
                    { name: 'The Bumble Bee', image: 'bugs_card/bee.png'},
                    { name: 'The Pill Bug', image: 'bugs_card/pill.png'},
                    { name: 'The Grass Hopper', image: 'bugs_card/cricket.png'},
                ],
                uncommon: [
                    { name: 'The Tiger Beetle', image: 'bugs_card/tiger.png' },
                    { name: 'The Black Beetle', image: 'bugs_card/blackbeetle.png' },
                    { name: 'The Diving Bell Spider', image: 'bugs_card/divingbell.png' },
                    { name: 'The Dung Beetle', image: 'bugs_card/dungbeetle.png' },
                    { name: 'The Mole Cricket', image: 'bugs_card/mole.png' },
                    { name: 'The Wasp', image: 'bugs_card/wasp.png' },
                ],
                legendary: [
                    { name: 'The Praying Mantis', image: 'bugs_card/mantis.png' },
                    { name: 'The Dragon Fly', image: 'bugs_card/dragon.png' },
                    { name: 'The Rhino Beetle', image: 'bugs_card/rihno.png' },
                ]
            };

            // Rarity chances (must add up to 100)
            const RARITY_CHANCES = {
                common: 75,     // ~74% chance
                uncommon: 23,   // ~23% chance
                legendary: 2      // 3% chance
            };

            // Audio settings
            const AUDIO_SETTINGS = {
                backgroundMusic: 'sfx/backtrack.mp3',
                packOpen: 'sfx/tcg pack open.mp3',
                cardSlam: 'sfx/Card Deal 2.wav',
                commonReveal: 'sfx/card_deal.mp3',
                uncommonReveal: 'sfx/card_deal.mp3',
                legendaryReveal: 'sfx/card_deal.mp3',
                legendaryAnoucement: 'sfx/legendary annoucement.mp3',
                uncommonAnoucement: 'sfx/uncommon.mp3',
                allCardsReveal: 'sfx/cardflips.mp3',
                allCardsReveal_withLegendary: ''
            };

            // Audio Management System
            class AudioManager {
                constructor() {
                    this.musicEnabled = true;
                    this.sfxEnabled = true;
                    this.volume = 0.5;
                    this.backgroundMusic = null;
                    this.musicWasPlaying = false;
                    this.initAudio();
                    this.setupVisibilityHandling();
                }

                initAudio() {
                    if (AUDIO_SETTINGS.backgroundMusic) {
                        this.backgroundMusic = new Audio(AUDIO_SETTINGS.backgroundMusic);
                        this.backgroundMusic.loop = true;
                        this.backgroundMusic.volume = this.volume * 0.3;
                    }
                    
                    document.addEventListener('click', () => {
                        if (this.musicEnabled) {
                            this.playBackgroundMusic();
                        }
                    }, { once: true });
                }

                setupVisibilityHandling() {
                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden) {
                            if (this.backgroundMusic && !this.backgroundMusic.paused) {
                                this.musicWasPlaying = true;
                                this.backgroundMusic.pause();
                            }
                        } else {
                            if (this.musicWasPlaying && this.musicEnabled && this.backgroundMusic) {
                                this.backgroundMusic.play().catch(e => console.log('Could not resume background music'));
                            }
                        }
                    });

                    window.addEventListener('blur', () => {
                        if (this.backgroundMusic && !this.backgroundMusic.paused) {
                            this.musicWasPlaying = true;
                            this.backgroundMusic.pause();
                        }
                    });

                    window.addEventListener('focus', () => {
                        if (this.musicWasPlaying && this.musicEnabled && this.backgroundMusic) {
                            this.backgroundMusic.play().catch(e => console.log('Could not resume background music'));
                        }
                    });
                }

                playAudio(filename, volume = 1.0) {
                    if (!this.sfxEnabled || !filename) return;
                    
                    const audio = new Audio(filename);
                    audio.volume = this.volume * volume;
                    audio.play().catch(e => console.log('Could not play audio:', filename));
                    
                    return audio;
                }

                playBackgroundMusic() {
                    if (!this.musicEnabled || !this.backgroundMusic) return;
                    
                    this.musicWasPlaying = true;
                    this.backgroundMusic.currentTime = 0;
                    this.backgroundMusic.play().catch(e => console.log('Could not play background music'));
                }

                stopBackgroundMusic() {
                    if (this.backgroundMusic) {
                        this.musicWasPlaying = false;
                        this.backgroundMusic.pause();
                        this.backgroundMusic.currentTime = 0;
                    }
                }

                play(soundName) {
                    const filename = AUDIO_SETTINGS[soundName];
                    if (filename) {
                        this.playAudio(filename);
                    }
                }
            }

            // Initialize audio manager
            const audioManager = new AudioManager();
            
            // Initialize pack image
            document.getElementById('packImage').src = PACK_IMAGE;
            const packImg = document.getElementById('packImage');
            window.setProtectedImage(packImg, PACK_IMAGE);
            
            let currentCardIndex = 0;
            let pulledCards = [];
            let canClickCard = false;
            
            // Create background particles
            function createParticles() {
                const container = document.getElementById('particles');
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 15 + 's';
                    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                    container.appendChild(particle);
                }
            }
            
            // Get random card based on rarity
            function getRandomCard() {
                const rand = Math.random() * 100;
                let rarity;
                
                if (rand < RARITY_CHANCES.legendary) {
                    rarity = 'legendary';
                } else if (rand < RARITY_CHANCES.legendary + RARITY_CHANCES.uncommon) {
                    rarity = 'uncommon';
                } else {
                    rarity = 'common';
                }
                
                const cards = CARD_COLLECTION[rarity];
                const card = cards[Math.floor(Math.random() * cards.length)];
                
                return { ...card, rarity };
            }
            
            // Generate 5 random cards
            function generatePack() {
                pulledCards = [];
                for (let i = 0; i < 5; i++) {
                    pulledCards.push(getRandomCard());
                }
            }
            
            // Create burst effect (simplified for performance)
            function createBurst(x, y, color, intensity = 20) {
                // Placeholder - you can implement particle effects here
            }
            
            // Create lightning effect for legendary
            function createLightning() {
                const lightning = document.getElementById('lightning');
                lightning.innerHTML = '';
                lightning.classList.add('active');
                
                for (let i = 0; i < 5; i++) {
                    const bolt = document.createElement('div');
                    bolt.className = 'lightning-bolt';
                    bolt.style.left = Math.random() * 100 + '%';
                    bolt.style.animationDelay = i * 0.1 + 's';
                    lightning.appendChild(bolt);
                }
                
                setTimeout(() => {
                    lightning.classList.remove('active');
                }, 1000);
            }
            
            // Update title with card name
            function updateTitle(card) {
                const title = document.getElementById('title');
                title.textContent = card.name;
                title.className = 'title card-name ' + card.rarity;
            }
            
            // Show card with animation
            function showCard(index) {
                const card = pulledCards[index];
                const cardElement = document.getElementById('currentCard');
                const cardImage = document.getElementById('cardImage');
                
                const newCard = cardElement.cloneNode(true);
                cardElement.parentNode.replaceChild(newCard, cardElement);
                
                const currentCard = document.getElementById('currentCard');
                const currentImage = document.getElementById('cardImage');
                
                currentCard.className = 'card ' + card.rarity;
                currentCard.classList.add('card-slam');
                currentCard.classList.remove('flipped');
                canClickCard = false;
                
                audioManager.play('cardSlam');
                updateTitle(card);
                window.setProtectedImage(currentImage, card.image);

                if (card.rarity === 'uncommon') {
                    audioManager.play('uncommonAnoucement');
                }
                
                if (card.rarity === 'legendary') {
                    audioManager.play('legendaryAnoucement');
                    const announcement = document.getElementById('legendaryAnnouncement');
                    announcement.classList.add('show');
                    setTimeout(() => announcement.classList.remove('show'), 2000);
                    
                    document.getElementById('mainContainer').classList.add('screen-shake');
                    setTimeout(() => {
                        document.getElementById('mainContainer').classList.remove('screen-shake');
                    }, 500);
                    
                    createLightning();
                }
                
                setTimeout(() => {
                    currentCard.classList.add('flipped');
                    canClickCard = true;
                    audioManager.play(card.rarity + 'Reveal');
                    const rect = currentCard.getBoundingClientRect();
                    const colors = {
                        common: '#999',
                        uncommon: '#0096ff',
                        legendary: '#ffd700'
                    };
                    const intensity = card.rarity === 'legendary' ? 30 : 15;
                    createBurst(rect.left + rect.width / 2, rect.top + rect.height / 2, colors[card.rarity], intensity);
                }, card.rarity === 'legendary' ? 1200 : 600);
                
                currentCard.addEventListener('click', function() {
                    if (!canClickCard) return;
                    
                    currentCardIndex++;
                    
                    if (currentCardIndex < 5) {
                        showCard(currentCardIndex);
                    } else {
                        displayAllCards();
                    }
                });
            }
            
            // Display all cards
            function displayAllCards() {
                const container = document.getElementById('allCardsDisplay');
                container.innerHTML = '';
                
                const legendaryPulled = pulledCards.some(card => card.rarity === 'legendary');
                if (legendaryPulled) {
                    audioManager.play('allCardsReveal_withLegendary');
                } else {
                    audioManager.play('allCardsReveal');
                }
                
                document.getElementById('title').textContent = 'Your Collection!';
                document.getElementById('title').className = 'title';
                

                pulledCards.forEach((card, i) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'small-card ' + card.rarity;
                    cardDiv.style.animationDelay = i * 0.1 + 's';
                    
                    const img = document.createElement('img');
                    window.setProtectedImage(img, card.image);
                    img.alt = card.name;
                    
                    const glow = document.createElement('div');
                    glow.className = 'rarity-glow';
                    glow.style.opacity = '1';
                    
                    cardDiv.appendChild(glow);
                    cardDiv.appendChild(img);
                    container.appendChild(cardDiv);

                    cardDiv.addEventListener('mouseenter', function(e) {
                        if (card.rarity === 'legendary') {
                            const rect = e.target.getBoundingClientRect();
                            createBurst(rect.left + rect.width / 2, rect.top + rect.height / 2, '#ffd700', 10);
                        }
                    });
                });
                
                document.getElementById('cardDisplay').style.display = 'none';
                container.style.display = 'flex';
            }
            
            // Pack click handler
            document.getElementById('packContainer').addEventListener('click', function() {
                if (!canOpenPack()) {
                    document.getElementById('lockedMessage').style.display = 'block';
                    return;
                }
                const title = document.getElementById('title');
                title.textContent = "";
                
                audioManager.play('packOpen');
                
                // Save opened date with user-specific key
                savePackOpening();
                
                generatePack();
                currentCardIndex = 0;
                
                const pack = document.getElementById('pack');
                pack.classList.add('opening');
                
                setTimeout(() => {
                    document.getElementById('energyRing1').classList.add('active');
                }, 100);
                setTimeout(() => {
                    document.getElementById('energyRing2').classList.add('active');
                }, 200);
                setTimeout(() => {
                    document.getElementById('energyRing3').classList.add('active');
                }, 300);
                
                const rect = pack.getBoundingClientRect();
                setTimeout(() => {
                    createBurst(rect.left + rect.width / 2, rect.top + rect.height / 2, '#ffffff', 20);
                }, 400);
                
                setTimeout(() => {
                    document.getElementById('packContainer').style.display = 'none';
                    document.getElementById('cardDisplay').style.display = 'block';
                    document.getElementById('flashOverlay').classList.remove('active');
                    showCard(0);
                }, 1300);
            });
            
            // Initialize particles
            createParticles();
            
            // Check if pack is locked on load
            const debugMode = new URLSearchParams(window.location.search).get('debug') === 'true';
            if (!debugMode && !canOpenPack()) {
                document.getElementById('packContainer').style.opacity = '0.5';
                document.getElementById('packContainer').style.pointerEvents = 'none';
                document.getElementById('lockedMessage').style.display = 'block';
                document.getElementById('title').textContent = 'Daily Pack Already Opened!';
            }
        }

        // Start the application
        initialize();
    </script>
</body>
</html>