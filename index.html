<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hexapod Pack Opener</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Discord Only Message -->
    <div id="discordOnly" style="display: none; text-align: center; padding: 50px; color: white;">
        <h1 style="color: #5865f2;">Discord Activity Only</h1>
        <p>This pack opener only works when launched as a Discord Activity.</p>
        <p>Join our Discord server and look for the pack opener activity!</p>
        <a href="https://discord.gg/your-invite" target="_blank" style="color: #5865f2; text-decoration: underline;">Join Discord Server</a>
    </div>

    <!-- Main Game Content -->
    <div class="particles" id="particles"></div>
    <div class="flash-overlay" id="flashOverlay"></div>
    <div class="lightning" id="lightning"></div>
    <div class="legendary-announcement" id="legendaryAnnouncement">LEGENDARY!</div>
    
    <!-- User Info - simple indicator -->
    <div id="userInfo" style="display: none; position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; color: #7cfc00; z-index: 1000;">
        Discord User
    </div>
    
    <div class="container" id="mainContainer">
        <h1 class="title" id="title">Open Your Daily Pack!</h1>
        
        <div class="pack-container" id="packContainer">
            <div class="pack" id="pack">
                <img src="" id="packImage" class="pack-image" alt="Card Pack">
            </div>
            <div class="energy-ring" id="energyRing1"></div>
            <div class="energy-ring" id="energyRing2"></div>
            <div class="energy-ring" id="energyRing3"></div>
        </div>
        
        <div class="card-display" id="cardDisplay">
            <div class="card" id="currentCard">
                <div class="rarity-glow"></div>
                <img src="" id="cardImage" class="card-image" alt="Card">
            </div>
            <div class="click-hint">Click card to continue</div>
        </div>
        
        <div class="all-cards-display" id="allCardsDisplay"></div>
        
        <div class="locked-message" id="lockedMessage" style="display: none;">
            You've already opened your daily pack! Come back tomorrow for more cards.
        </div>
    </div>

    <script>
        // Simple Discord detection - just check if we're in an iframe
        let discordUser = null;
        let isInDiscord = false;

        function detectDiscordContext() {
            console.log('=== DISCORD DETECTION DEBUG ===');
            console.log('window.parent !== window:', window.parent !== window);
            console.log('window.top !== window:', window.top !== window);
            console.log('location.href:', window.location.href);
            console.log('document.referrer:', document.referrer);
            console.log('window.location.ancestorOrigins:', window.location.ancestorOrigins);
            
            // Simple detection: if we're in an iframe, assume Discord
            const inIframe = window.parent !== window || window.top !== window;
            
            if (inIframe) {
                console.log('✅ DETECTED: Running in iframe (likely Discord Activity)');
                return true;
            } else {
                console.log('❌ NOT DETECTED: Running in main window (direct browser access)');
                return false;
            }
        }

        // Create a simple user ID for rate limiting
        function createDiscordUser() {
            // Create a consistent user ID based on session
            let userId = sessionStorage.getItem('discord_activity_user');
            if (!userId) {
                userId = 'discord_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                sessionStorage.setItem('discord_activity_user', userId);
            }
            
            discordUser = {
                id: userId,
                username: 'Discord User',
                avatar: null
            };
            
            console.log('Created user:', discordUser);
            return discordUser;
        }

        // Modified storage functions for per-user rate limiting
        function getStorageKey() {
            if (discordUser && discordUser.id) {
                return `hexapod_last_opened_${discordUser.id}`;
            }
            return 'hexapod_last_opened_fallback';
        }

        function canOpenPack() {
            const storageKey = getStorageKey();
            const lastOpened = localStorage.getItem(storageKey);
            if (!lastOpened) return true;
            
            const lastDate = new Date(lastOpened);
            const today = new Date();
            
            const lastMidnight = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
            const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            return todayMidnight > lastMidnight;
        }

        function savePackOpening() {
            const storageKey = getStorageKey();
            localStorage.setItem(storageKey, new Date().toISOString());
        }

        // Main initialization
        function initializeApp() {
            console.log('🚀 Starting app initialization...');
            
            // Detect Discord context
            isInDiscord = detectDiscordContext();
            
            if (!isInDiscord) {
                console.log('👆 Showing Discord-only message');
                document.getElementById('discordOnly').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
                return;
            }
            
            console.log('🎮 In Discord Activity - initializing game');
            
            // Create user for rate limiting
            createDiscordUser();
            
            // Show user indicator
            document.getElementById('userInfo').style.display = 'block';
            
            // Initialize the game
            document.getElementById('discordOnly').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            initializeGame();
        }

        // Initialize the original game code
        function initializeGame() {
            console.log('🎯 Initializing game...');
            
            // Protection code
            (function() {
                'use strict';
                
                const urlParams = new URLSearchParams(window.location.search);
                const debugMode = urlParams.get('debug') === 'true';
                
                if (!debugMode) {
                    document.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        return false;
                    });
                    
                    document.addEventListener('keydown', function(e) {
                        if (e.keyCode === 123 || 
                            (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                            (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 65 || e.keyCode === 80))) {
                            e.preventDefault();
                            return false;
                        }
                    });
                }
                
                document.addEventListener('dragstart', function(e) {
                    if (e.target.tagName === 'IMG') {
                        e.preventDefault();
                        return false;
                    }
                });
                
                document.addEventListener('selectstart', function(e) {
                    if (e.target.tagName === 'IMG') {
                        e.preventDefault();
                        return false;
                    }
                });
                
                window.setProtectedImage = function(imgElement, src) {
                    imgElement.src = src;
                    imgElement.style.webkitUserSelect = 'none';
                    imgElement.style.mozUserSelect = 'none';
                    imgElement.style.msUserSelect = 'none';
                    imgElement.style.userSelect = 'none';
                    imgElement.draggable = false;
                };
            })();
            
            // Game constants (your original data)
            const PACK_IMAGE = 'HexapodTCGPack.png';
            
            const CARD_COLLECTION = {
                common: [
                    { name: 'The Soldier Ant', image: 'bugs_card/ant.png' },
                    { name: 'The House Spider', image: 'bugs_card/spider.png'},
                    { name: 'The Bumble Bee', image: 'bugs_card/bee.png'},
                    { name: 'The Pill Bug', image: 'bugs_card/pill.png'},
                    { name: 'The Grass Hopper', image: 'bugs_card/cricket.png'},
                ],
                uncommon: [
                    { name: 'The Tiger Beetle', image: 'bugs_card/tiger.png' },
                    { name: 'The Black Beetle', image: 'bugs_card/blackbeetle.png' },
                    { name: 'The Diving Bell Spider', image: 'bugs_card/divingbell.png' },
                    { name: 'The Dung Beetle', image: 'bugs_card/dungbeetle.png' },
                    { name: 'The Mole Cricket', image: 'bugs_card/mole.png' },
                    { name: 'The Wasp', image: 'bugs_card/wasp.png' },
                ],
                legendary: [
                    { name: 'The Praying Mantis', image: 'bugs_card/mantis.png' },
                    { name: 'The Dragon Fly', image: 'bugs_card/dragon.png' },
                    { name: 'The Rhino Beetle', image: 'bugs_card/rihno.png' },
                ]
            };

            const RARITY_CHANCES = {
                common: 75,
                uncommon: 23,
                legendary: 2
            };

            const AUDIO_SETTINGS = {
                backgroundMusic: 'sfx/backtrack.mp3',
                packOpen: 'sfx/tcg pack open.mp3',
                cardSlam: 'sfx/Card Deal 2.wav',
                commonReveal: 'sfx/card_deal.mp3',
                uncommonReveal: 'sfx/card_deal.mp3',
                legendaryReveal: 'sfx/card_deal.mp3',
                legendaryAnoucement: 'sfx/legendary annoucement.mp3',
                uncommonAnoucement: 'sfx/uncommon.mp3',
                allCardsReveal: 'sfx/cardflips.mp3',
                allCardsReveal_withLegendary: ''
            };

            // Audio Manager
            class AudioManager {
                constructor() {
                    this.musicEnabled = true;
                    this.sfxEnabled = true;
                    this.volume = 0.5;
                    this.backgroundMusic = null;
                    this.musicWasPlaying = false;
                    this.initAudio();
                    this.setupVisibilityHandling();
                }

                initAudio() {
                    if (AUDIO_SETTINGS.backgroundMusic) {
                        this.backgroundMusic = new Audio(AUDIO_SETTINGS.backgroundMusic);
                        this.backgroundMusic.loop = true;
                        this.backgroundMusic.volume = this.volume * 0.3;
                    }
                    
                    document.addEventListener('click', () => {
                        if (this.musicEnabled) {
                            this.playBackgroundMusic();
                        }
                    }, { once: true });
                }

                setupVisibilityHandling() {
                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden) {
                            if (this.backgroundMusic && !this.backgroundMusic.paused) {
                                this.musicWasPlaying = true;
                                this.backgroundMusic.pause();
                            }
                        } else {
                            if (this.musicWasPlaying && this.musicEnabled && this.backgroundMusic) {
                                this.backgroundMusic.play().catch(e => console.log('Could not resume background music'));
                            }
                        }
                    });

                    window.addEventListener('blur', () => {
                        if (this.backgroundMusic && !this.backgroundMusic.paused) {
                            this.musicWasPlaying = true;
                            this.backgroundMusic.pause();
                        }
                    });

                    window.addEventListener('focus', () => {
                        if (this.musicWasPlaying && this.musicEnabled && this.backgroundMusic) {
                            this.backgroundMusic.play().catch(e => console.log('Could not resume background music'));
                        }
                    });
                }

                playAudio(filename, volume = 1.0) {
                    if (!this.sfxEnabled || !filename) return;
                    
                    const audio = new Audio(filename);
                    audio.volume = this.volume * volume;
                    audio.play().catch(e => console.log('Could not play audio:', filename));
                    
                    return audio;
                }

                playBackgroundMusic() {
                    if (!this.musicEnabled || !this.backgroundMusic) return;
                    
                    this.musicWasPlaying = true;
                    this.backgroundMusic.currentTime = 0;
                    this.backgroundMusic.play().catch(e => console.log('Could not play background music'));
                }

                stopBackgroundMusic() {
                    if (this.backgroundMusic) {
                        this.musicWasPlaying = false;
                        this.backgroundMusic.pause();
                        this.backgroundMusic.currentTime = 0;
                    }
                }

                play(soundName) {
                    const filename = AUDIO_SETTINGS[soundName];
                    if (filename) {
                        this.playAudio(filename);
                    }
                }
            }

            const audioManager = new AudioManager();
            
            // Initialize pack image
            document.getElementById('packImage').src = PACK_IMAGE;
            const packImg = document.getElementById('packImage');
            window.setProtectedImage(packImg, PACK_IMAGE);
            
            let currentCardIndex = 0;
            let pulledCards = [];
            let canClickCard = false;
            
            function createParticles() {
                const container = document.getElementById('particles');
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 15 + 's';
                    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                    container.appendChild(particle);
                }
            }
            
            function getRandomCard() {
                const rand = Math.random() * 100;
                let rarity;
                
                if (rand < RARITY_CHANCES.legendary) {
                    rarity = 'legendary';
                } else if (rand < RARITY_CHANCES.legendary + RARITY_CHANCES.uncommon) {
                    rarity = 'uncommon';
                } else {
                    rarity = 'common';
                }
                
                const cards = CARD_COLLECTION[rarity];
                const card = cards[Math.floor(Math.random() * cards.length)];
                
                return { ...card, rarity };
            }
            
            function generatePack() {
                pulledCards = [];
                for (let i = 0; i < 5; i++) {
                    pulledCards.push(getRandomCard());
                }
            }
            
            function createBurst(x, y, color, intensity = 20) {
                // Placeholder for burst effects
            }
            
            function createLightning() {
                const lightning = document.getElementById('lightning');
                lightning.innerHTML = '';
                lightning.classList.add('active');
                
                for (let i = 0; i < 5; i++) {
                    const bolt = document.createElement('div');
                    bolt.className = 'lightning-bolt';
                    bolt.style.left = Math.random() * 100 + '%';
                    bolt.style.animationDelay = i * 0.1 + 's';
                    lightning.appendChild(bolt);
                }
                
                setTimeout(() => {
                    lightning.classList.remove('active');
                }, 1000);
            }
            
            function updateTitle(card) {
                const title = document.getElementById('title');
                title.textContent = card.name;
                title.className = 'title card-name ' + card.rarity;
            }
            
            function showCard(index) {
                const card = pulledCards[index];
                const cardElement = document.getElementById('currentCard');
                
                const newCard = cardElement.cloneNode(true);
                cardElement.parentNode.replaceChild(newCard, cardElement);
                
                const currentCard = document.getElementById('currentCard');
                const currentImage = document.getElementById('cardImage');
                
                currentCard.className = 'card ' + card.rarity;
                currentCard.classList.add('card-slam');
                currentCard.classList.remove('flipped');
                canClickCard = false;
                
                audioManager.play('cardSlam');
                updateTitle(card);
                window.setProtectedImage(currentImage, card.image);

                if (card.rarity === 'uncommon') {
                    audioManager.play('uncommonAnoucement');
                }
                
                if (card.rarity === 'legendary') {
                    audioManager.play('legendaryAnoucement');
                    const announcement = document.getElementById('legendaryAnnouncement');
                    announcement.classList.add('show');
                    setTimeout(() => announcement.classList.remove('show'), 2000);
                    
                    document.getElementById('mainContainer').classList.add('screen-shake');
                    setTimeout(() => {
                        document.getElementById('mainContainer').classList.remove('screen-shake');
                    }, 500);
                    
                    createLightning();
                }
                
                setTimeout(() => {
                    currentCard.classList.add('flipped');
                    canClickCard = true;
                    audioManager.play(card.rarity + 'Reveal');
                    const rect = currentCard.getBoundingClientRect();
                    const colors = {
                        common: '#999',
                        uncommon: '#0096ff',
                        legendary: '#ffd700'
                    };
                    const intensity = card.rarity === 'legendary' ? 30 : 15;
                    createBurst(rect.left + rect.width / 2, rect.top + rect.height / 2, colors[card.rarity], intensity);
                }, card.rarity === 'legendary' ? 1200 : 600);
                
                currentCard.addEventListener('click', function() {
                    if (!canClickCard) return;
                    
                    currentCardIndex++;
                    
                    if (currentCardIndex < 5) {
                        showCard(currentCardIndex);
                    } else {
                        displayAllCards();
                    }
                });
            }
            
            function displayAllCards() {
                const container = document.getElementById('allCardsDisplay');
                container.innerHTML = '';
                
                const legendaryPulled = pulledCards.some(card => card.rarity === 'legendary');
                if (legendaryPulled) {
                    audioManager.play('allCardsReveal_withLegendary');
                } else {
                    audioManager.play('allCardsReveal');
                }
                
                document.getElementById('title').textContent = 'Your Collection!';
                document.getElementById('title').className = 'title';

                pulledCards.forEach((card, i) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'small-card ' + card.rarity;
                    cardDiv.style.animationDelay = i * 0.1 + 's';
                    
                    const img = document.createElement('img');
                    window.setProtectedImage(img, card.image);
                    img.alt = card.name;
                    
                    const glow = document.createElement('div');
                    glow.className = 'rarity-glow';
                    glow.style.opacity = '1';
                    
                    cardDiv.appendChild(glow);
                    cardDiv.appendChild(img);
                    container.appendChild(cardDiv);

                    cardDiv.addEventListener('mouseenter', function(e) {
                        if (card.rarity === 'legendary') {
                            const rect = e.target.getBoundingClientRect();
                            createBurst(rect.left + rect.width / 2, rect.top + rect.height / 2, '#ffd700', 10);
                        }
                    });
                });

                document.getElementById('cardDisplay').style.display = 'none';
                container.style.display = 'flex';
            }
            
            // Pack click handler with Discord user-specific rate limiting
            document.getElementById('packContainer').addEventListener('click', function() {
                if (!canOpenPack()) {
                    document.getElementById('lockedMessage').style.display = 'block';
                    return;
                }
                const title = document.getElementById('title');
                title.textContent = "";
                
                audioManager.play('packOpen');
                
                savePackOpening(); // Now uses Discord user ID
                
                generatePack();
                currentCardIndex = 0;
                
                const pack = document.getElementById('pack');
                pack.classList.add('opening');
                
                setTimeout(() => {
                    document.getElementById('energyRing1').classList.add('active');
                }, 100);
                setTimeout(() => {
                    document.getElementById('energyRing2').classList.add('active');
                }, 200);
                setTimeout(() => {
                    document.getElementById('energyRing3').classList.add('active');
                }, 300);
                
                const rect = pack.getBoundingClientRect();
                setTimeout(() => {
                    createBurst(rect.left + rect.width / 2, rect.top + rect.height / 2, '#ffffff', 20);
                }, 400);
                
                setTimeout(() => {
                    document.getElementById('packContainer').style.display = 'none';
                    document.getElementById('cardDisplay').style.display = 'block';
                    document.getElementById('flashOverlay').classList.remove('active');
                    showCard(0);
                }, 1300);
            });
            
            createParticles();
            
            // Check if pack is locked on load
            const debugMode = new URLSearchParams(window.location.search).get('debug') === 'true';
            if (!debugMode && !canOpenPack()) {
                document.getElementById('packContainer').style.opacity = '0.5';
                document.getElementById('packContainer').style.pointerEvents = 'none';
                document.getElementById('lockedMessage').style.display = 'block';
                document.getElementById('title').textContent = 'Daily Pack Already Opened!';
            }
            
            console.log('✅ Game initialization complete!');
        }

        // Debug helper for manual testing
        window.forceDiscordMode = function() {
            console.log('🔧 FORCING DISCORD MODE');
            isInDiscord = true;
            initializeApp();
        };

        window.forceNormalMode = function() {
            console.log('🔧 FORCING NORMAL MODE');
            isInDiscord = false;
            initializeApp();
        };

        // Start the app
        console.log('🎬 App starting...');
        initializeApp();
    </script>
</body>
</html>